{% extends "base.html" %} {% block title %}ë¡œë˜ì§€ë‹ˆ ë¶„ì„{% endblock %} {% block
header_title %}ğŸ§â€â™‚ï¸ ë¡œë˜ì§€ë‹ˆ ë¶„ì„{% endblock %} {% block styles %}
<style>
  .chart-container {
    position: relative;
    margin-bottom: 2rem;
    height: 400px;
    width: 100%;
  }

  /* Ensure container is responsive */
  .container {
    max-width: 1000px; /* Override base max-width if needed, or stick to 800px? Analysis usually needs more width */
  }

  /* Override base container max-width for charts */
  @media (min-width: 850px) {
    .container {
      max-width: 1000px;
    }
  }

  /* Mobile responsive for charts */
  @media (max-width: 768px) {
    .chart-container {
      height: 300px;
      margin-bottom: 1.5rem;
    }

    h2 {
      font-size: 1.2rem;
    }

    p {
      font-size: 0.85rem;
    }
  }

  @media (max-width: 480px) {
    .chart-container {
      height: 250px;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 1rem;
    }
  }
</style>
{% endblock %} 

{% block content %}
<div class="container">
  <h2>ë²ˆí˜¸ë³„ ì¶œí˜„ ë¹ˆë„ (ì „ì²´)</h2>
  <div class="chart-container">
    <canvas id="freqChart"></canvas>
  </div>

  <h2>ìµœê·¼ 20íšŒ ë²ˆí˜¸ë³„ ì¶œí˜„ ë¹„ìœ¨</h2>
  <div class="chart-container">
    <canvas id="pieChart"></canvas>
  </div>

  <h2>ë‹¹ì²¨ ë²ˆí˜¸ íë¦„ (ì „ì²´)</h2>
  <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem">
    â€» ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ, ë“œë˜ê·¸ë¡œ ì´ë™ ê°€ëŠ¥ (ì „ì²´ íšŒì°¨ ë°ì´í„° í‘œì‹œ)
  </p>
  <div class="chart-container">
    <canvas id="trendChart"></canvas>
  </div>

  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>ì—­ëŒ€ 1ë“± ë‹¹ì²¨ì ìˆ˜ (ì¶”ì„¸)</h2>
    <span id="total-winner-count" style="font-weight: bold; color: #6200ea;"></span>
  </div>
  <div class="chart-container">
    <canvas id="winnerChart"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
<script id="freq-data" type="application/json">
  {{ freq_data | tojson | safe }}
</script>
<script id="recent-data" type="application/json">
  {{ recent_freq_data | tojson | safe }}
</script>
<script id="trend-data" type="application/json">
  {{ trend_data | tojson | safe }}
</script>
<script id="winner-data" type="application/json">
  {{ winner_data | tojson | safe }}
</script>

<script>
  // Parse data from hidden JSON blocks to avoid linter errors with Jinja syntax
  const freqData = JSON.parse(document.getElementById('freq-data').textContent);
  const recentData = JSON.parse(document.getElementById('recent-data').textContent);
  const trendData = JSON.parse(document.getElementById('trend-data').textContent);

  // Frequency Data (All)
  const freqLabels = Object.keys(freqData);
  const freqValues = Object.values(freqData);

  // Recent Frequency Data (Pie)
  // Filter to show only numbers that appeared
  const recentLabelsRaw = Object.keys(recentData);
  const recentValues = Object.values(recentData);

  // Calculate Total for Percentages
  const recentTotal = recentValues.reduce((a, b) => a + b, 0);
  const recentLabels = recentLabelsRaw.map((label, index) => {
    const percent = ((recentValues[index] / recentTotal) * 100).toFixed(1);
    return `${label} (${percent}%)`;
  });

  // Trend Data
  const trendLabels = trendData.map((d) => d.round_no + "íšŒ");

  // Prepare datasets for scatter/line chart
  // We want to show 6 numbers per round.
  // Chart.js scatter expects x, y. x=round, y=number.
  const scatterData = [];
  trendData.forEach((d) => {
    for (let i = 1; i <= 6; i++) {
      scatterData.push({ x: d.round_no, y: d[`num${i}`] });
    }
  });

  // Calculate initial zoom range (show last 20 rounds)
  let initialMinX = null;
  let initialMaxX = null;
  if (trendData.length > 0) {
    const maxRound = Math.max(...trendData.map(d => d.round_no));
    initialMaxX = maxRound;
    initialMinX = Math.max(trendData[0].round_no, maxRound - 19); // Show last 20 rounds
  }

  // Color mapping helper
  function getColor(n) {
    if (n <= 10) return "#fbc400"; // Yellow
    if (n <= 20) return "#69c8f2"; // Blue
    if (n <= 30) return "#ff7272"; // Red
    if (n <= 40) return "#aaaaaa"; // Gray
    return "#b0d840"; // Green
  }

  // 1. Frequency Chart
  const ctxFreq = document.getElementById("freqChart").getContext("2d");
  new Chart(ctxFreq, {
    type: "bar",
    data: {
      labels: freqLabels,
      datasets: [
        {
          label: "ì¶œí˜„ íšŸìˆ˜",
          data: freqValues,
          backgroundColor: freqLabels.map((n) => getColor(parseInt(n))),
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  // 2. Pie Chart (Recent 20)
  const ctxPie = document.getElementById("pieChart").getContext("2d");
  new Chart(ctxPie, {
    type: "pie",
    data: {
      labels: recentLabels,
      datasets: [
        {
          data: recentValues,
          backgroundColor: recentLabelsRaw.map((n) => getColor(parseInt(n))),
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "right",
        },
      },
    },
  });

  // 3. Trend Chart
  const ctxTrend = document.getElementById("trendChart").getContext("2d");
  new Chart(ctxTrend, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "ë‹¹ì²¨ ë²ˆí˜¸",
          data: scatterData,
          backgroundColor: scatterData.map((d) => getColor(d.y)),
          pointRadius: 6,
          pointHoverRadius: 8,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: "nearest",
        axis: "x",
        intersect: false,
      },
      scales: {
        x: {
          type: "linear",
          position: "bottom",
          title: { display: true, text: "íšŒì°¨" },
          ticks: {
            stepSize: 1,
            autoSkip: true,
            maxTicksLimit: 20,
          },
          min: initialMinX,
          max: initialMaxX,
        },
        y: {
          min: 1,
          max: 45,
          title: { display: true, text: "ë²ˆí˜¸" },
        },
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.raw.x + "íšŒ: " + context.raw.y;
            },
          },
        },
        zoom: {
          limits: {
            x: { 
              minRange: 5,
              min: trendData.length > 0 ? Math.min(...trendData.map(d => d.round_no)) : undefined,
              max: trendData.length > 0 ? Math.max(...trendData.map(d => d.round_no)) : undefined,
            },
          },
          zoom: {
            wheel: {
              enabled: true,
            },
            pinch: {
              enabled: true,
            },
            mode: "x",
          },
          pan: {
            enabled: true,
            mode: "x",
          },
        },
      },
    },
  });

  // 4. Winner Count Chart
  const winnerData = JSON.parse(document.getElementById('winner-data').textContent);
  if (winnerData && winnerData.length > 0) {
      const winnerLabels = winnerData.map(d => d.round_no + "íšŒ (" + d.draw_date + ")");
      const winnerCounts = winnerData.map(d => d.winner_count);

      // Calculate and display total
      const totalWinners = winnerCounts.reduce((a, b) => a + b, 0);
      document.getElementById('total-winner-count').textContent = `ì´ 1ë“± ë‹¹ì²¨ì ìˆ˜ : ${totalWinners.toLocaleString()}ëª…`;

      // Determine initial view range (last 20 rounds)
      let minVal = undefined;
      let maxVal = undefined;
      if (winnerLabels.length > 20) {
          minVal = winnerLabels[winnerLabels.length - 20];
          maxVal = winnerLabels[winnerLabels.length - 1];
      }

      const ctxWinner = document.getElementById("winnerChart").getContext("2d");
      new Chart(ctxWinner, {
        type: "line",
        data: {
          labels: winnerLabels,
          datasets: [{
            label: "1ë“± ë‹¹ì²¨ì ìˆ˜",
            data: winnerCounts,
            borderColor: "#6200ea",
            backgroundColor: "rgba(98, 0, 234, 0.1)",
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "ëª…" },
              ticks: { precision: 0 }
            },
            x: {
               min: minVal,
               max: maxVal,
               ticks: {
                   maxTicksLimit: 12
               }
            }
          },
          plugins: {
             zoom: {
                pan: { enabled: true, mode: 'x' },
                zoom: { 
                  wheel: { enabled: true }, 
                  pinch: { enabled: true }, 
                  mode: 'x',
                },
                limits: {
                    x: { minRange: 5 } 
                }
             }
          }
        }
      });
  }
</script>
{% endblock %}

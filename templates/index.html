{% extends "base.html" %}

{% block title %}로또지니 대시보드{% endblock %}

{% block styles %}
<style>
    .result-card {
      background: #ede7f6;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    /* Specific overrides if needed, since base.html tables are centered */
    td span.ball {
        /* Ensuring balls look good in table */
        vertical-align: middle;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .result-card {
            padding: 0.75rem;
        }

        .result-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        table {
            font-size: 0.85rem;
        }

        th, td {
            padding: 0.5rem 0.3rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {% macro get_ball_class(n) %}
    {% if n <= 10 %}ball-yellow{% elif n <= 20 %}ball-blue{% elif n <= 30 %}ball-red{% elif n <= 40 %}ball-gray{% else %}ball-green{% endif %}
    {% endmacro %}

    <h2>최신 당첨 결과</h2>
    {% if latest_result %}
    <div class="result-card">
      <h3>{{ latest_result['round_no'] }}회 ({{ latest_result['draw_date'] }})</h3>
      <div>
        <span class="ball {{ get_ball_class(latest_result['num1']) }}">{{ latest_result['num1'] }}</span>
        <span class="ball {{ get_ball_class(latest_result['num2']) }}">{{ latest_result['num2'] }}</span>
        <span class="ball {{ get_ball_class(latest_result['num3']) }}">{{ latest_result['num3'] }}</span>
        <span class="ball {{ get_ball_class(latest_result['num4']) }}">{{ latest_result['num4'] }}</span>
        <span class="ball {{ get_ball_class(latest_result['num5']) }}">{{ latest_result['num5'] }}</span>
        <span class="ball {{ get_ball_class(latest_result['num6']) }}">{{ latest_result['num6'] }}</span>
        +
        <span class="ball {{ get_ball_class(latest_result['bonus']) }}">{{ latest_result['bonus'] }}</span>
      </div>
    </div>
    {% else %}
    <p>저장된 당첨 내역이 없습니다.</p>
    {% endif %}

    {% if prizes %}
    <h3>당첨금 정보</h3>
    <div class="table-wrapper">
    <table style="margin-bottom: 2rem;">
        <thead>
            <tr>
                <th>순위</th>
                <th style="text-align: right;">총 당첨금액</th>
                <th style="text-align: right;">당첨자 수</th>
                <th style="text-align: right;">1게임당 당첨금액</th>
                <th style="text-align: center;">비고</th>
            </tr>
        </thead>
        <tbody>
            {% for prize in prizes %}
            <tr>
                <td>{{ prize.rank_no }}등</td>
                <td style="text-align: right;">{{ "{:,}".format(prize.total_price) }}원</td>
                <td style="text-align: right;">{{ "{:,}".format(prize.winner_count) }}명</td>
                <td style="text-align: right;">{{ "{:,}".format(prize.win_amount) }}원</td>
                {% if loop.first %}
                <td rowspan="{{ prizes|length }}" style="vertical-align: middle; text-align: center; width: 100px;">
                    {% if latest_result.first_prize_auto or latest_result.first_prize_manual %}
                        <div style="display: flex; flex-direction: column; gap: 0.3rem; align-items: center; justify-content: center; min-height: 100%;">
                            <div style="font-weight: bold;">1등</div>
                            {% if latest_result.first_prize_auto %}
                            <div>자동{{ latest_result.first_prize_auto }}</div>
                            {% endif %}
                            {% if latest_result.first_prize_manual %}
                            <div>수동{{ latest_result.first_prize_manual }}</div>
                            {% endif %}
                            {% if latest_result.first_prize_semi_auto %}
                            <div>반자동{{ latest_result.first_prize_semi_auto }}</div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 100%;">-</div>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% endif %}

    <h2>예측 번호 생성</h2>
    {% if user %}
    <p>아래 버튼을 클릭하여 최신 데이터를 기반으로 새로운 예측 번호를 생성하세요.</p>
    <button id="genBtn" class="btn" onclick="generatePrediction()">지금 생성하기</button>
    {% else %}
    <p>예측 번호를 생성하려면 로그인이 필요합니다.</p>
    <a href="/login" class="btn">로그인하러 가기</a>
    {% endif %}

    <h2>최근 예측 내역</h2>
    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>회차</th>
          <th>번호</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody>
        {% for pred in predictions %}
        <tr>
          <td>{{ pred['round_no'] }}회</td>
          <td>
            <span class="ball {{ get_ball_class(pred['num1']) }}">{{ pred['num1'] }}</span>
            <span class="ball {{ get_ball_class(pred['num2']) }}">{{ pred['num2'] }}</span>
            <span class="ball {{ get_ball_class(pred['num3']) }}">{{ pred['num3'] }}</span>
            <span class="ball {{ get_ball_class(pred['num4']) }}">{{ pred['num4'] }}</span>
            <span class="ball {{ get_ball_class(pred['num5']) }}">{{ pred['num5'] }}</span>
            <span class="ball {{ get_ball_class(pred['num6']) }}">{{ pred['num6'] }}</span>
          </td>
          <td>{{ pred['rank_val'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function generatePrediction() {
        if (confirm("새로운 예측 번호를 생성하시겠습니까?")) {
          const btn = document.getElementById('genBtn');
          btn.disabled = true;
          btn.innerText = "생성 중...";

          // Use predict_web endpoint which checks cookie
          try {
            const response = await fetch('/predict_web', { method: 'POST' });

            if (response.ok) {
              const result = await response.json();
              alert("예측 번호가 생성되었습니다!");
              location.reload();
            } else {
              alert("오류가 발생했습니다. 다시 로그인해주세요.");
              location.href = '/login';
            }
          } catch (e) {
            console.error(e);
            alert("서버 연결 오류");
            btn.disabled = false;
            btn.innerText = "지금 생성하기";
          }
        }
    }
</script>
{% endblock %}